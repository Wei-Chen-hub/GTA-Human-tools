import os
import pickle
import numpy as np
import smplx
import torch
import trimesh

import matplotlib.pyplot as plt
import cv2
from convert_data import convert_smpl
import open3d as o3d

ptc_dir = r'D:\ptc'
smpl_dir = r'C:\Users\12595\Desktop\GTA-test-data\smpl\smpl_fitting'


def main():
    seq_path = r'\\wsl$\Ubuntu-20.04\home\weichen\zoehuman\smplify_2d_test\saas_expose\azhe_dy00'
    kps2d = np.load(os.path.join(seq_path, 'cocowholebody_keypoints2d.npy'))
    bbox = np.load(os.path.join(seq_path, 'bbox.npy'))

    # print(kps2d[0])
    scale_factor = 1.1

    width = max(bbox[:, 2] - bbox[:, 0]) * scale_factor
    height = max(bbox[:, 3] - bbox[:, 1]) * scale_factor

    # center = np.concatenate((kps2d[:, 11, :2].reshape(-1, 1, 2), kps2d[:, 12, :2].reshape(-1, 1, 2)), axis=2)
    center = (kps2d[:, 11, :2] + kps2d[:, 12, :2]) / 2
    center = np.array([[218.43782, 555.588, 560.2218, 1201.4097],
                       [219.96208, 556.2876, 561.74603, 1202.1093],
                       [221.84145, 557.77747, 563.6254, 1203.5991],
                       [224.2057, 559.2039, 565.9897, 1205.0256],
                       [226.45988, 560.707, 568.24384, 1206.5286],
                       [228.29488, 561.2762, 570.07886, 1207.0979],
                       [230.0606, 561.85516, 571.84454, 1207.6768],
                       [231.45427, 562.10986, 573.2382, 1207.9315],
                       [232.43312, 562.4332, 574.2171, 1208.2549],
                       [233.03804, 563.0052, 574.822, 1208.8269],
                       [233.59657, 562.2843, 575.38055, 1208.106],
                       [233.63478, 562.7018, 575.41876, 1208.5234],
                       [233.67305, 562.1943, 575.45703, 1208.0159],
                       [233.5645, 561.28156, 575.34845, 1207.1033],
                       [233.29594, 560.34424, 575.0799, 1206.1659],
                       [232.92662, 559.8763, 574.7106, 1205.698],
                       [232.50627, 558.50714, 574.2902, 1204.3289],
                       [232.08733, 557.2045, 573.8713, 1203.0261],
                       [231.51488, 556.54144, 573.2988, 1202.363],
                       [230.77504, 556.30695, 572.559, 1202.1287],
                       [229.50111, 555.9835, 571.2851, 1201.8052],
                       [227.82945, 556.3742, 569.6134, 1202.1958],
                       [225.16057, 556.7926, 566.9445, 1202.6143],
                       [222.02818, 556.9274, 563.81213, 1202.749],
                       [218.61086, 557.1128, 560.39484, 1202.9344],
                       [215.01445, 557.09296, 556.7984, 1202.9146],
                       [211.49599, 555.9562, 553.27997, 1201.7778],
                       [208.3108, 556.45264, 550.0948, 1202.2743],
                       [205.30022, 555.75793, 547.08417, 1201.5796],
                       [202.55116, 555.01385, 544.33514, 1200.8354],
                       [200.06483, 555.9382, 541.8488, 1201.7598],
                       [198.15492, 556.27606, 539.9389, 1202.0977],
                       [196.76653, 555.7169, 538.5505, 1201.5386],
                       [195.80083, 556.49817, 537.5848, 1202.3198],
                       [195.17155, 556.6464, 536.9555, 1202.468],
                       [194.89961, 556.4948, 536.6836, 1202.3164],
                       [194.37029, 557.9006, 536.15424, 1203.7222],
                       [193.70363, 558.9914, 535.4876, 1204.813],
                       [192.97963, 560.8478, 534.7636, 1206.6694],
                       [192.17632, 563.5837, 533.96027, 1209.4053],
                       [191.90962, 567.9707, 533.6936, 1213.7924],
                       [192.15721, 571.9552, 533.94116, 1217.7769],
                       [193.18477, 577.30304, 534.96875, 1223.1248],
                       [194.5767, 583.1823, 536.36066, 1229.0039],
                       [196.75877, 587.83984, 538.5427, 1233.6615],
                       [199.57085, 590.288, 541.3548, 1236.1096],
                       [202.44527, 592.1969, 544.22925, 1238.0186],
                       [205.28941, 592.60785, 547.07336, 1238.4294],
                       [208.42229, 592.23206, 550.20624, 1238.0537],
                       [211.2476, 591.5552, 553.03156, 1237.3768],
                       [213.10881, 590.3079, 554.89276, 1236.1296],
                       [214.71233, 588.20636, 556.4963, 1234.0281],
                       [216.02559, 585.976, 557.8096, 1231.7976],
                       [216.99126, 582.72003, 558.7752, 1228.5417],
                       [217.45012, 580.1093, 559.2341, 1225.9309],
                       [217.64354, 577.94824, 559.4275, 1223.7699],
                       [217.77339, 577.28076, 559.5574, 1223.1024],
                       [217.66032, 576.96387, 559.4443, 1222.7855],
                       [217.44746, 576.95294, 559.23145, 1222.7747],
                       [217.18437, 577.7946, 558.9683, 1223.6162],
                       [216.85933, 577.569, 558.6433, 1223.3906],
                       [216.79903, 577.646, 558.583, 1223.4677],
                       [216.23259, 577.26526, 558.01654, 1223.0869],
                       [214.91917, 576.5727, 556.7031, 1222.3943],
                       [213.45134, 576.1423, 555.2353, 1221.9639],
                       [211.72282, 578.1877, 553.5068, 1224.0093],
                       [209.0909, 579.4938, 550.8749, 1225.3154],
                       [206.63039, 582.8332, 548.41437, 1228.6548],
                       [204.11852, 585.6995, 545.90247, 1231.5212],
                       [201.34578, 587.6758, 543.12976, 1233.4974],
                       [198.26872, 586.88763, 540.0527, 1232.7092],
                       [195.32927, 586.45325, 537.1132, 1232.2749],
                       [192.01933, 583.5632, 533.8033, 1229.3848],
                       [189.21663, 582.0762, 531.0006, 1227.8978],
                       [186.20338, 578.9399, 527.98737, 1224.7615],
                       [183.82405, 576.15216, 525.60803, 1221.9739],
                       [181.49126, 574.0505, 523.2752, 1219.8721],
                       [179.70763, 572.1494, 521.4916, 1217.9711],
                       [178.22807, 570.14886, 520.012, 1215.9705],
                       [177.53828, 570.34735, 519.32227, 1216.169],
                       [177.02483, 572.0581, 518.8088, 1217.8798],
                       [176.88829, 573.30255, 518.67224, 1219.1243],
                       [176.87196, 575.12396, 518.65594, 1220.9456],
                       [177.09435, 578.01605, 518.8783, 1223.8376],
                       [177.47609, 580.46204, 519.2601, 1226.2837],
                       [178.09117, 583.0646, 519.8751, 1228.8862],
                       [179.32262, 585.1003, 521.10657, 1230.9219],
                       [180.95757, 587.1733, 522.7415, 1232.9949],
                       [182.5996, 588.09924, 524.38354, 1233.9209],
                       [184.45695, 589.5659, 526.2409, 1235.3876],
                       [186.97154, 590.888, 528.7555, 1236.7097],
                       [188.87141, 592.80804, 530.6554, 1238.6296],
                       [191.02556, 594.0387, 532.8095, 1239.8604],
                       [193.71208, 595.2011, 535.49603, 1241.0227],
                       [196.59227, 594.58545, 538.3762, 1240.4071],
                       [198.95052, 592.42334, 540.7345, 1238.245],
                       [201.73161, 588.57367, 543.51556, 1234.3953],
                       [204.14503, 585.6222, 545.929, 1231.4438],
                       [205.71553, 582.4005, 547.4995, 1228.2222],
                       [206.72911, 580.40265, 548.51306, 1226.2244]], dtype=np.float32)
    print(width, height)

    bbox_refined = np.concatenate(((center[:, 0] - 0.5 * width).reshape(-1, 1),
                                   (center[:, 1] - 0.6 * height).reshape(-1, 1),
                                   (center[:, 0] + 0.5 * width).reshape(-1, 1),
                                   (center[:, 0] + 0.4 * height).reshape(-1, 1)), axis=1)

    aaa = bbox[:, 2]
    bbb = np.std(aaa, ddof=1) / np.sqrt(np.size(aaa))
    ccc = np.std(aaa * 2, ddof=1) / np.sqrt(np.size(aaa))
    print(bbb, ccc)


def test_kps():
    aaa = [[109.0640, 98.8570],
           [114.8460, 89.9510],
           [102.7771, 88.9139],
           [108.7749, 109.3232],
           [127.3935, 56.1376],
           [92.0200, 56.3322],
           [109.8258, 121.3257],
           [127.5417, 20.1039],
           [90.8147, 18.8825],
           [108.7632, 125.3278],
           [133.6865, 11.7074],
           [85.2365, 10.6440],
           [107.3775, 141.3889],
           [113.1177, 133.4054],
           [104.0812, 133.3872],
           [109.3888, 154.9730],
           [123.7619, 140.0258],
           [93.8038, 136.9325],
           [140.0220, 124.1749],
           [85.6385, 111.9603],
           [139.6417, 142.6243],
           [90.4654, 100.0952],
           [107.8883, 155.0911],
           [111.1764, 156.0872],
           [105.0565, 155.7876],
           [141.4801, 152.1649],
           [141.6178, 154.7970],
           [139.9150, 154.5672],
           [142.7953, 151.9007],
           [141.7486, 154.0850],
           [139.5282, 153.6482],
           [142.8084, 148.3837],
           [141.7274, 149.8550],
           [139.8965, 149.8937],
           [143.0493, 150.0532],
           [141.6586, 152.1763],
           [139.3972, 151.8152],
           [138.5187, 147.2988],
           [139.0679, 149.5142],
           [140.5464, 151.5182],
           [93.9098, 96.3457],
           [95.1273, 93.5286],
           [94.5711, 94.7799],
           [92.1790, 94.7947],
           [93.9294, 93.0609],
           [93.3024, 95.0634],
           [89.4530, 92.9889],
           [90.8600, 93.2770],
           [90.0787, 94.6671],
           [90.5048, 93.7291],
           [92.4643, 92.8777],
           [91.6151, 94.9034],
           [94.0971, 98.7147],
           [93.9479, 95.9743],
           [93.9386, 94.4894],
           [108.3005, 150.8050],
           [104.9874, 155.2471],
           [111.4699, 155.6582],
           [101.5264, 155.8416],
           [115.1949, 157.0028],
           [132.7458, 10.0392],
           [137.7450, 11.1864],
           [128.9486, 18.2914],
           [88.0453, 9.3780],
           [82.1391, 10.2899],
           [91.5564, 15.5077],
           [141.6336, 153.2811],
           [137.7100, 154.0795],
           [137.0849, 152.6834],
           [137.5421, 150.9796],
           [138.0246, 149.5902],
           [92.5914, 91.7426],
           [94.2080, 96.7726],
           [92.2967, 97.1028],
           [90.9633, 96.4622],
           [88.6005, 95.9671],
           [102.1891, 156.4891],
           [102.9401, 157.4478],
           [104.3363, 157.3753],
           [105.8392, 157.0595],
           [107.1289, 156.6606],
           [108.9346, 156.7482],
           [110.1929, 157.2909],
           [111.6807, 157.7494],
           [113.0922, 157.9603],
           [114.0636, 157.0902],
           [108.0936, 155.1724],
           [108.1495, 153.8633],
           [108.1961, 152.6757],
           [108.2536, 151.4875],
           [107.1703, 151.0385],
           [107.7366, 150.7546],
           [108.3495, 150.5499],
           [108.9415, 150.8322],
           [109.4827, 151.1841],
           [103.7743, 155.4780],
           [104.5883, 155.7065],
           [105.5477, 155.6958],
           [106.3919, 155.2703],
           [105.6370, 154.9341],
           [104.7081, 154.8862],
           [109.8887, 155.4462],
           [110.6595, 155.9449],
           [111.6190, 156.0725],
           [112.5138, 155.9358],
           [111.6016, 155.2516],
           [110.6675, 155.2023],
           [106.1937, 149.0240],
           [106.8798, 149.1703],
           [107.8298, 149.2313],
           [108.4432, 149.1667],
           [109.0506, 149.2980],
           [110.0420, 149.3422],
           [110.8298, 149.2657],
           [110.1724, 148.5790],
           [109.1731, 148.1496],
           [108.5267, 148.0492],
           [107.8666, 148.0621],
           [106.8512, 148.3850],
           [106.2552, 149.0496],
           [107.8777, 148.8803],
           [108.4902, 148.8817],
           [109.1029, 148.9540],
           [110.8050, 149.2753],
           [109.1622, 148.8545],
           [108.4887, 148.7927],
           [107.8197, 148.7776],
           [101.1911, 156.7762],
           [101.5132, 154.5501],
           [101.8371, 152.8761],
           [102.1884, 151.2775],
           [102.8394, 149.5574],
           [103.8121, 147.9811],
           [105.2295, 146.5548],
           [107.0050, 145.3720],
           [108.6674, 145.0559],
           [110.3063, 145.5449],
           [111.9470, 146.8376],
           [113.3045, 148.4343],
           [114.1757, 150.1522],
           [114.7485, 152.0142],
           [114.9678, 153.7492],
           [115.1094, 155.4619], [115.1110, 157.6188]]

    bbb = [[1.7444, -133.1827],
           [123.4383, 112.2866],
           [100.4751, 112.6718],
           [1.7444, -133.1827],
           [131.6530, 150.1844],
           [92.7948, 148.9010],
           [1.7444, -133.1827],
           [135.9014, 186.8194],
           [94.6915, 187.9255],
           [1.7444, -133.1827],
           [1.7444, -133.1827],
           [1.7444, -133.1827],
           [1.7444, -133.1827],
           [1.7444, -133.1827],
           [1.7444, -133.1827],
           [1.7444, -133.1827],
           [126.9803, 53.3163],
           [94.1823, 57.9930],
           [146.2643, 70.4152],
           [89.4781, 81.8430],
           [148.9811, 48.1228],
           [90.8540, 93.2702],
           [1.7444, -133.1827],
           [1.7444, -133.1827],
           [1.7444, -133.1827],
           [151.3374, 39.0769],
           [151.0815, 36.7525],
           [149.6927, 35.2297],
           [152.3992, 39.3763],
           [151.6431, 36.8243],
           [149.7247, 35.2706],
           [151.7897, 40.5519],
           [151.0406, 38.8674],
           [149.8794, 37.9115],
           [152.3650, 39.9288],
           [151.4678, 37.6668],
           [149.7164, 36.3361],
           [148.4482, 44.0620],
           [147.5686, 40.4734],
           [147.5020, 38.1690],
           [94.6756, 102.5688],
           [95.6714, 104.8442],
           [96.2720, 105.1440],
           [92.4921, 103.4103],
           [93.7128, 105.4344],
           [94.4214, 105.2984],
           [89.5051, 103.5154],
           [90.1416, 104.8263],
           [90.7777, 104.9957],
           [90.6300, 103.6429],
           [91.6943, 105.3332],
           [92.4729, 105.2515],
           [93.3794, 96.3755],
           [95.9138, 98.9824],
           [97.0703, 101.5142],
           [110.2856, 41.7680],
           [107.1534, 38.4569],
           [113.4662, 38.6456],
           [102.4003, 39.4116],
           [117.8642, 39.0498],
           [143.7562, 199.7009],
           [143.4353, 199.2406],
           [133.6278, 190.2157],
           [86.0617, 200.5974],
           [86.3988, 200.1971],
           [98.4490, 192.0022],
           [147.5581, 36.4928],
           [148.4933, 34.4940],
           [148.3855, 34.7648],
           [148.5285, 35.8129],
           [148.9537, 37.3599],
           [97.4425, 103.3174],
           [96.4705, 104.8337],
           [94.7178, 104.6431],
           [92.9538, 104.6548],
           [91.3395, 104.7013],
           [106.2124, 38.0884],
           [106.9994, 37.9885],
           [107.5773, 37.9937],
           [108.2201, 38.0690],
           [109.0101, 38.2038],
           [111.4476, 38.1793],
           [112.2886, 38.0497],
           [112.9948, 38.0299],
           [113.6078, 38.0983],
           [114.3600, 38.2214],
           [110.2115, 38.9843],
           [110.2094, 39.9813],
           [110.2240, 41.1049],
           [110.2840, 42.0132],
           [109.1882, 42.4266],
           [109.8045, 42.6078],
           [110.4517, 42.6623],
           [111.0881, 42.5926],
           [111.6884, 42.4119],
           [106.3736, 38.5334],
           [106.9788, 38.3982],
           [107.6318, 38.4504],
           [108.3344, 38.7567],
           [107.5279, 38.7135],
           [106.8718, 38.6450],
           [112.1846, 38.8742],
           [112.9469, 38.5944],
           [113.6711, 38.5991],
           [114.2975, 38.7555],
           [113.7958, 38.8791],
           [113.0760, 38.9077],
           [108.7583, 43.8350],
           [109.4270, 43.4884],
           [110.2379, 43.2734],
           [110.6093, 43.2601],
           [110.9829, 43.2493],
           [111.8407, 43.4151],
           [112.5405, 43.7184],
           [111.9156, 43.9815],
           [111.2312, 44.0949],
           [110.5494, 44.1398],
           [109.9173, 44.1614],
           [109.3289, 44.0907],
           [108.9214, 43.8372],
           [109.7514, 43.6146],
           [110.6241, 43.4726],
           [111.5222, 43.5498],
           [112.3761, 43.7252],
           [111.4798, 43.7647],
           [110.5811, 43.7298],
           [109.7406, 43.8367],
           [102.9439, 38.6146],
           [103.1916, 39.6597],
           [104.6583, 41.3339],
           [105.9866, 42.8371],
           [106.6316, 43.8557],
           [107.3516, 44.8033],
           [108.3430, 45.8144],
           [109.4978, 46.5794],
           [110.6875, 46.7793],
           [111.8643, 46.3963],
           [112.9849, 45.5768],
           [113.9394, 44.5898],
           [114.5808, 43.6534],
           [115.0578, 42.6254],
           [116.0263, 41.1131],
           [117.1598, 39.4030],
           [117.2855, 38.3277]]


def concat_video(overlay_dir, mode):
    # support missing frames video construction

    RECORD_FPS = 30

    for seq in sorted(os.listdir(overlay_dir)):
        print(seq)
        dst = os.path.join(overlay_dir, seq)
        img = os.path.join(overlay_dir, seq, 'smplx_vis')

        cmd = (f'ffmpeg.exe -y -r {RECORD_FPS} -f image2 -s 1080x1920 -i {img}\\%6d.png '
               f'-vcodec libx264 -crf 25 -pix_fmt yuv420p {dst}\\vis_smplx.mp4'
               )
        # call(cmd, shell=True)
        os.system(cmd)

        concat_two_video = True
        if concat_two_video:
            cmd = (f'ffmpeg -y -i {dst}\\video.mp4 -i {dst}\\smplx.mp4 '
                   f'-filter_complex "[0:v]pad=iw*2:ih[a];[a][1:v]overlay=w*1" '
                   # f'-map "[out]" -movflags faststart {dst}\\concat_smplx.mp4')
                   # f'-vcodec libx264 -crf 25 -pix_fmt yuv420p {dst}\\{mode}_smplify2d.mp4')
                   rf'-vcodec libx264 -crf 25 -pix_fmt yuv420p C:\Users\12595\Desktop\smplifyx2d\vis\{seq}.mp4')
            os.system(cmd)

        concat_four_video = False
        if concat_four_video:
            cmd = (f'ffmpeg -y -i {dst}\\video.mp4 -i {dst}\\vis_kps.mp4 '
                   f'-i {dst}\\smplx.mp4 -i {dst}\\vis_smplx.mp4 '
                   f'-filter_complex "[0:v]pad=iw*2:ih*2[a];[a][1:v]overlay=w[b];'
                   f'[b][2:v]overlay=0:h[c];[c][3:v]overlay=w:h" '
                   f'-vcodec libx264 -crf 25 -pix_fmt yuv420p {dst}\\four_in_1.mp4')
            os.system(cmd)

        concat_kps2d_expose_pymafx = True
        if concat_kps2d_expose_pymafx:
            pass


def test_smplx():
    smplx_sample = r'C:\Users\12595\Desktop\GTA-test-data\smplx\smplx_fitting\seq_00007425_092195.npz'
    param = dict(np.load(smplx_sample, allow_pickle=True))

    kwargs = {'flat_hand_mean': True, 'use_face_contour': True, 'use_pca': True, 'num_betas': 10,
              'optim_j_regressor': False, 'num_pca_comps': 24, 'batch_size': 55, }
    body_model = smplx.create(r'\\wsl$\Ubuntu-20.04\home\weichen\zoehuman\mmhuman3d\data\body_models',
                              model_type='smplx', **kwargs).to('cuda')
    torch_device = 'cuda'

    smplx_model = dict(np.load(r'\\wsl$\Ubuntu-20.04\home\weichen\zoehuman\mmhuman3d'
                               r'\data\body_models\smplx\SMPLX_NEUTRAL.npz', allow_pickle=True))
    hl = smplx_model['hands_componentsl']
    hr = smplx_model['hands_componentsr']
    import pdb; pdb.set_trace()
    output = body_model(
        global_orient=torch.tensor(param['global_orient'], device=torch_device),
        body_pose=torch.tensor(param['body_pose'], device=torch_device),
        transl=torch.tensor(param['transl'], device=torch_device),
        betas=torch.tensor(param['betas'], device=torch_device),
        left_hand_pose=torch.tensor(param['left_hand_pose'], device=torch_device),
        right_hand_pose=torch.tensor(param['right_hand_pose'], device=torch_device),
        # expression=torch.tensor(param['expression'], device=torch_device),
        # jaw_pose=torch.tensor(param['jaw_pose'], device=torch_device),
        # leye_pose=torch.tensor(param['leye_pose'], device=torch_device),
        # reye_pose=torch.tensor(param['reye_pose'], device=torch_device),
        return_verts=True)


if __name__ == '__main__':
    # main()
    # test_smplx()
    mode = 'pymafx'# 'expose'
    concat_video(overlay_dir=r'\\wsl$\Ubuntu-20.04\home\weichen\zoehuman\smplify_2d_test\saas_' + mode, mode=mode)
